/* Editor styles with CSS variable support for theming */
@import "../../shared/typography.css";

:root {
  --editor-bg: #ffffff;
  --editor-text: #000000;
  --editor-selection: rgba(0, 122, 255, 0.3);
  --accent-color: #007aff;
}

/* Global link theming - ensures injected HTML (e.g., citeproc) uses theme colors */
a {
  color: var(--accent-color);
}

html,
body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: var(--editor-bg);
  color: var(--editor-text);
  font-family: var(--font-sans);
  font-size: var(--font-size-body);
  line-height: var(--line-height-body, 1.75);
  font-weight: var(--weight-body, 400);
}

#editor {
  padding: 24px 48px;
  min-height: 100%;
  outline: none;
  max-width: var(--column-max-width);
  min-width: var(--column-min-width);
  margin: 0 auto;
}

.milkdown {
  background: var(--editor-bg);
  color: var(--editor-text);
}
.milkdown .editor {
  outline: none;
}
.ProseMirror {
  outline: none;
}
.ProseMirror ::selection {
  background: var(--editor-selection);
}

/* Focus mode dimming */
.ff-dimmed {
  opacity: 0.3;
  transition: opacity 0.2s ease;
}

/* Typography */
/* Target both .milkdown and .ProseMirror for compatibility */
.milkdown h1,
.ProseMirror h1,
.milkdown h2,
.ProseMirror h2,
.milkdown h3,
.ProseMirror h3,
.milkdown h4,
.ProseMirror h4,
.milkdown h5,
.ProseMirror h5,
.milkdown h6,
.ProseMirror h6 {
  color: var(--editor-heading-text, var(--editor-text));
  margin-top: 1.5em;
  margin-bottom: 0.5em;
  line-height: var(--line-height-heading);
  font-weight: var(--weight-heading, 600);
  text-wrap: balance;
}

/* Empty heading placeholder - shows ## when heading has no content (WYSIWYG mode only) */
/* Uses heading-empty class toggled by heading-nodeview-plugin.ts based on node content */
.ProseMirror h1.heading-empty::before,
.ProseMirror h2.heading-empty::before,
.ProseMirror h3.heading-empty::before,
.ProseMirror h4.heading-empty::before,
.ProseMirror h5.heading-empty::before,
.ProseMirror h6.heading-empty::before {
  content: attr(data-placeholder);
  color: var(--editor-muted, #999);
  font-style: italic;
  pointer-events: none;
}

.milkdown h1,
.ProseMirror h1 {
  font-size: var(--font-size-h1);
  letter-spacing: var(--tracking-tight);
}

.milkdown h2,
.ProseMirror h2 {
  font-size: var(--font-size-h2);
  letter-spacing: var(--tracking-tight);
}

.milkdown h3,
.ProseMirror h3 {
  font-size: var(--font-size-h3);
}
.milkdown h4,
.ProseMirror h4 {
  font-size: var(--font-size-h4);
}
.milkdown h5,
.ProseMirror h5 {
  font-size: var(--font-size-h5);
}
.milkdown h6,
.ProseMirror h6 {
  font-size: var(--font-size-h6);
}

.milkdown p,
.ProseMirror p {
  margin: 0.75em 0;
  line-height: var(--line-height-body);
  text-wrap: pretty;
}

/* Code */
.milkdown code,
.ProseMirror code {
  background: rgba(128, 128, 128, 0.1);
  padding: 0.2em 0.4em;
  border-radius: 3px;
  font-family: var(--font-mono);
  font-size: 0.9em;
}

.milkdown pre,
.ProseMirror pre {
  background: rgba(128, 128, 128, 0.1);
  padding: 1em;
  border-radius: 6px;
  overflow-x: auto;
  font-family: var(--font-mono);
}

/* Links and lists */
.milkdown a,
.ProseMirror a {
  color: var(--accent-color);
  text-decoration: none;
}
.milkdown a:hover,
.ProseMirror a:hover {
  text-decoration: underline;
}
.milkdown ul,
.ProseMirror ul,
.milkdown ol,
.ProseMirror ol {
  padding-left: 1.5em;
}
.milkdown li,
.ProseMirror li {
  margin: 0.25em 0;
}
.milkdown blockquote,
.ProseMirror blockquote {
  border-left: 4px solid var(--accent-color);
  margin: 1em 0;
  padding-left: 1em;
  opacity: 0.9;
}

/* Section break - compact visual separator */
.section-break {
  display: block;
  color: var(--editor-muted, #999);
  font-size: 1.5em;
  line-height: 1; /* Keep symbol compact - no extra vertical space */
  text-align: left;
  user-select: all;
  cursor: default;
  margin: 8px 0; /* Fixed small margin for minimal visual footprint */
}

/* Hide slash menu when SlashProvider sets data-show="false" */
.slash-menu[data-show="false"] {
  display: none;
}

/* === Annotation Styles === */

/* Base annotation container (Hybrid pattern) */
.ff-annotation {
  display: inline;
  font-size: 0.9em;
  padding: 0 2px;
  border-radius: 2px;
  vertical-align: baseline;
  background: rgba(128, 128, 128, 0.05);
}

/* Non-editable marker */
.ff-annotation-marker {
  user-select: none;
  margin-right: 2px;
}

/* Editable text area */
.ff-annotation-text {
  outline: none;
  min-width: 1em;
  display: inline;
}

/* Empty annotation placeholder */
.ff-annotation-text:empty::before {
  content: "type here...";
  color: var(--editor-muted, #999);
  font-style: italic;
}

/* Task annotation */
.ff-annotation-task {
  color: var(--annotation-task, #f59e0b);
}

.ff-annotation-task.ff-annotation-completed {
  color: var(--annotation-task-completed, #10b981);
}

/* Comment annotation */
.ff-annotation-comment {
  color: var(--annotation-comment, #3b82f6);
}

/* Reference annotation */
.ff-annotation-reference {
  color: var(--annotation-reference, #8b5cf6);
}

/* Hidden mode (panel-only) */
.ff-annotation-hidden {
  display: none;
}

/* Collapsed mode - marker only, hide text */
.ff-annotation-collapsed {
  opacity: 0.6;
  position: relative;
  background: transparent;
  padding: 0;
}

/* Hide the text in collapsed mode */
.ff-annotation-collapsed .ff-annotation-text {
  display: none;
}

/* Remove margin from marker when collapsed */
.ff-annotation-collapsed .ff-annotation-marker {
  margin-right: 0;
}

/* Tooltip for collapsed annotations - shows full text on hover */
.ff-annotation-collapsed::after {
  content: attr(data-text);
  position: absolute;
  left: 50%;
  bottom: 100%;
  transform: translateX(-50%);
  padding: 6px 10px;
  background: var(--tooltip-bg, #1f2937);
  color: var(--tooltip-text, #f3f4f6);
  font-size: 12px;
  line-height: 1.4;
  border-radius: 6px;
  white-space: pre-wrap;
  max-width: 280px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
  opacity: 0;
  visibility: hidden;
  transition:
    opacity 0.15s ease,
    visibility 0.15s ease;
  z-index: 1000;
  pointer-events: none;
  margin-bottom: 4px;
}

/* Arrow for tooltip */
.ff-annotation-collapsed::before {
  content: "";
  position: absolute;
  left: 50%;
  bottom: 100%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: var(--tooltip-bg, #1f2937);
  opacity: 0;
  visibility: hidden;
  transition:
    opacity 0.15s ease,
    visibility 0.15s ease;
  z-index: 1001;
  margin-bottom: -1px;
}

/* Show tooltip on hover */
.ff-annotation-collapsed:hover::after,
.ff-annotation-collapsed:hover::before {
  opacity: 1;
  visibility: visible;
}

/* Hover states */
.ff-annotation:hover {
  opacity: 1;
  background: rgba(128, 128, 128, 0.1);
}

/* === Highlight Styles === */

/* Highlight mark for ==text== */
.ff-highlight,
mark.ff-highlight {
  background-color: var(--highlight-bg, rgba(255, 235, 59, 0.4));
  color: inherit;
  padding: 0 2px;
  border-radius: 2px;
}

/* Dark mode adjustment */
@media (prefers-color-scheme: dark) {
  .ff-highlight,
  mark.ff-highlight {
    background-color: var(--highlight-bg, rgba(255, 235, 59, 0.25));
  }
}

/* === Citation Styles === */

/* Base citation container */
.ff-citation {
  display: inline;
  font-size: 0.95em;
  padding: 1px 4px;
  border-radius: 3px;
  cursor: pointer;
  transition: background 0.15s ease;
}

/* Resolved citation (valid citekey) */
.ff-citation-resolved {
  color: var(--citation-resolved, #059669);
  background: rgba(5, 150, 105, 0.08);
}

.ff-citation-resolved:hover {
  background: rgba(5, 150, 105, 0.15);
}

/* Unresolved citation (unknown citekey) */
.ff-citation-unresolved {
  color: var(--citation-unresolved, #dc2626);
  background: rgba(220, 38, 38, 0.08);
}

.ff-citation-unresolved:hover {
  background: rgba(220, 38, 38, 0.15);
}

/* Citation in edit mode */
.ff-citation-editing {
  font-family: "SF Mono", Menlo, Monaco, monospace;
  font-size: 0.9em;
  background: rgba(128, 128, 128, 0.1);
  color: var(--editor-text);
  outline: 2px solid var(--accent-color, #007aff);
  outline-offset: 1px;
}

/* Citation search popup results */
.ff-citation-search-item:hover {
  background: var(--editor-selection, rgba(0, 122, 255, 0.15));
}

.ff-citation-search-item.selected {
  background: var(--editor-selection, #e8f0fe);
}

/* === Auto-Bibliography Markers === */

/* Auto-bibliography markers - invisible in editor but preserved in DOM */
.auto-bib-start,
.auto-bib-end {
  display: none;
}

/* === Source Mode Styles === */

/* Global source mode body class */
body.source-mode {
  /* Use monospace font throughout in source mode */
}

body.source-mode .ProseMirror {
  /* Font inherits from body (user's --font-sans selection) */
  /* Inherit --font-size and --line-height from user preferences (set by Swift via setTheme) */
}

/* Source mode syntax markers - muted appearance */
.source-mode-syntax {
  color: var(--editor-muted, #666);
  opacity: 0.7;
  user-select: none;
  font-family: var(--font-mono);
}

/* Source mode heading NodeView - renders # prefix as styled span */
/* The heading-nodeview-plugin handles rendering in source mode */
/* Note: .heading-source-mode classes are styled via body.source-mode h1-h6 rules above */

body.source-mode .heading-source-mode .heading-content {
  /* Content includes ## prefix in text content now */
  /* Prefix styling is handled by .heading-prefix-syntax class */
}

/* Fallback ::before rules for headings not using NodeView (e.g., during transitions) */
body.source-mode h1:not(.heading-source-mode)::before {
  content: "# ";
  color: var(--syntax-heading, #0ea5e9);
  font-weight: bold;
}
body.source-mode h2:not(.heading-source-mode)::before {
  content: "## ";
  color: var(--syntax-heading, #0ea5e9);
  font-weight: bold;
}
body.source-mode h3:not(.heading-source-mode)::before {
  content: "### ";
  color: var(--syntax-heading, #0ea5e9);
  font-weight: bold;
}
body.source-mode h4:not(.heading-source-mode)::before {
  content: "#### ";
  color: var(--syntax-heading, #0ea5e9);
  font-weight: bold;
}
body.source-mode h5:not(.heading-source-mode)::before {
  content: "##### ";
  color: var(--syntax-heading, #0ea5e9);
  font-weight: bold;
}
body.source-mode h6:not(.heading-source-mode)::before {
  content: "###### ";
  color: var(--syntax-heading, #0ea5e9);
  font-weight: bold;
}

/* Legacy class for widget decorations (if any remain) */
.source-mode-heading-marker {
  color: var(--syntax-heading, #0ea5e9);
  font-weight: bold;
}

/* Blockquote marker: > */
.source-mode-blockquote-marker {
  color: var(--syntax-blockquote, #10b981);
}

/* List markers: - or 1. */
.source-mode-list-marker {
  color: var(--syntax-list, #8b5cf6);
}

/* Code fence: ``` */
.source-mode-code-fence {
  color: var(--syntax-code, #f59e0b);
  display: block;
  margin: 0.25em 0;
}

/* Bold markers: ** */
.source-mode-bold-marker {
  color: var(--syntax-bold, #f43f5e);
}

/* Italic markers: * */
.source-mode-italic-marker {
  color: var(--syntax-italic, #f43f5e);
}

/* Inline code markers: ` */
.source-mode-code-marker {
  color: var(--syntax-inline-code, #f59e0b);
}

/* Strikethrough markers: ~~ */
.source-mode-strike-marker {
  color: var(--syntax-strike, #6b7280);
}

/* Link markers: []() */
.source-mode-link-marker {
  color: var(--syntax-link, #3b82f6);
}

/* Horizontal rule in source mode */
.source-mode-hr::before {
  content: attr(data-syntax);
  color: var(--syntax-hr, #6b7280);
}

/* === Source Mode Heading Styles === */
/* Headings retain visual hierarchy while showing ## prefix */

body.source-mode h1,
body.source-mode .heading-source-mode.heading-level-1 {
  font-size: var(--font-size-h1);
  font-weight: var(--weight-heading, 600);
  color: var(--editor-heading-text, var(--editor-text));
  line-height: var(--line-height-heading);
  margin: 1em 0 0.5em 0;
}

body.source-mode h2,
body.source-mode .heading-source-mode.heading-level-2 {
  font-size: var(--font-size-h2);
  font-weight: var(--weight-heading, 600);
  color: var(--editor-heading-text, var(--editor-text));
  line-height: var(--line-height-heading);
  margin: 1em 0 0.5em 0;
}

body.source-mode h3,
body.source-mode .heading-source-mode.heading-level-3 {
  font-size: var(--font-size-h3);
  font-weight: var(--weight-heading, 600);
  color: var(--editor-heading-text, var(--editor-text));
  line-height: var(--line-height-heading);
  margin: 0.75em 0 0.5em 0;
}

body.source-mode h4,
body.source-mode .heading-source-mode.heading-level-4 {
  font-size: var(--font-size-h4);
  font-weight: var(--weight-heading, 600);
  color: var(--editor-heading-text, var(--editor-text));
  line-height: var(--line-height-heading);
  margin: 0.75em 0 0.5em 0;
}

body.source-mode h5,
body.source-mode .heading-source-mode.heading-level-5 {
  font-size: var(--font-size-h5);
  font-weight: var(--weight-heading, 600);
  color: var(--editor-heading-text, var(--editor-text));
  line-height: var(--line-height-heading);
  margin: 0.5em 0;
}

body.source-mode h6,
body.source-mode .heading-source-mode.heading-level-6 {
  font-size: var(--font-size-h6);
  font-weight: var(--weight-heading, 600);
  color: var(--editor-heading-text, var(--editor-text));
  line-height: var(--line-height-heading);
  margin: 0.5em 0;
}

/* Note: Heading # markers are displayed via CSS ::before pseudo-elements
   They are not editable text - heading levels are changed via toolbar/keyboard shortcuts */

body.source-mode blockquote {
  border-left: none;
  padding-left: 0;
  margin: 0.5em 0;
  opacity: 1;
}

body.source-mode code {
  background: none;
  padding: 0;
  border-radius: 0;
}

body.source-mode pre {
  background: rgba(128, 128, 128, 0.05);
  padding: 0.5em;
  margin: 0.5em 0;
}

/* Source mode line numbers (optional, for future enhancement) */
body.source-mode .ProseMirror {
  counter-reset: line;
}

/* Make section breaks visible as text in source mode */
body.source-mode .section-break {
  color: var(--syntax-comment, #6b7280);
  font-family: var(--font-mono);
}

/* Source mode: annotations show as raw HTML comment syntax */
body.source-mode .ff-annotation,
.source-mode-annotation {
  font-family: var(--font-mono);
  color: var(--syntax-comment, #6b7280);
  background: transparent;
  padding: 0;
}

/* Source mode: citations show as raw pandoc syntax */
body.source-mode .ff-citation,
.source-mode-citation {
  font-family: var(--font-mono);
  color: var(--syntax-link, #3b82f6);
  background: transparent;
  padding: 0;
}

/* === Search Highlighting === */

/* Search match highlight */
.search-match {
  background-color: rgba(255, 255, 0, 0.4);
  border-radius: 2px;
}

/* Current (selected) search match */
.search-match.search-match-current {
  background-color: rgba(255, 165, 0, 0.6);
  box-shadow: 0 0 0 1px rgba(255, 165, 0, 0.8);
}
